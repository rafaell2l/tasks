<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {/* v9.2 - Backlog Edit Priority/Duration */}
    <title>Gestione Attivit√† v9.2 - Layout Compatto</title>
    <style>
        /* --- Base & General Styles (Mostly Unchanged) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.5; margin: 0; padding: 15px; background-color: #f4f7f9; color: #333; font-size: 0.95em; }
        h1, h2 { color: #3a5f8a; margin-bottom: 12px; border-bottom: 1px solid #dce4ec; padding-bottom: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 1.3em; }
        h2 { font-size: 1.15em; }
        .container { max-width: 1200px; margin: 15px auto; }
        .app { width: 100%; display: flex; flex-direction: column; gap: 20px; }
        .card { background-color: #fff; padding: 15px 20px; border: 1px solid #dce4ec; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); overflow-x: auto; }

        /* Form Styling (Slightly Compacted) */
        .add-task-section label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85em; color: #555; }
        .add-task-section input[type="text"], .add-task-section select,
        /* Add styles for inline edit inputs */
        #backlog-table .edit-priority-input, #backlog-table .edit-duration-input
        {
            width: 100%; padding: 6px 8px; /* Slightly smaller padding */
            margin-bottom: 0; /* Remove margin for inline */
            border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em;
        }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; } .form-row > div { flex: 1; } .form-row label, .form-row input, .form-row select { margin-bottom: 0; width: 100%; }
        .add-task-section button, #toggle-completed-button, .export-section button { padding: 8px 15px; background-color: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease-in-out; margin-right: 8px; margin-bottom: 8px; }
        .add-task-section button:hover, #toggle-completed-button:hover, .export-section button:hover { background-color: #357abd; }
        .export-section button { background-color: #607d8b; } .export-section button:hover { background-color: #455a64; }
        .export-section button.copy-btn { background-color: #7cb342; } .export-section button.copy-btn:hover { background-color: #558b2f; }
        #toggle-db-button { font-size: 0.7em; padding: 4px 8px; background-color: #90a4ae; font-weight: normal; margin-left: auto; margin-right: 0; color: white; border: none; border-radius: 3px; cursor: pointer;} #toggle-db-button:hover { background-color: #78909c; }

        /* --- Backlog Table Styles --- */
        .backlog-section .table-wrapper,
        .queue-section .table-wrapper,
        .completed-section .table-wrapper,
        .templates-section .table-wrapper
        { margin-top: 10px; }

        #backlog-table { width: 100%; border-collapse: collapse; font-size: 0.9em; table-layout: fixed; }
        #backlog-table thead th { background-color: #e9edf1; border: 1px solid #dce4ec; padding: 6px 8px; text-align: left; font-weight: 600; color: #4a6a8a; font-size: 0.85em; white-space: nowrap; }
        #backlog-table tbody tr.backlog-group-header td { background-color: #e9edf1; padding: 6px 10px; margin-top: 5px; border-bottom: 1px solid #dce4ec; border-top: 1px solid #dce4ec; font-weight: 600; color: #3a5f8a; font-size: 0.9em; cursor: pointer; transition: background-color 0.15s ease-in-out; }
        #backlog-table tbody tr.backlog-group-header:hover { background-color: #e1e7ed; }
        .toggle-indicator { display: inline-block; margin-right: 6px; transition: transform 0.2s ease-in-out; font-size: 0.8em; color: #5a7a9a; width: 10px; text-align: center; }
        tr.backlog-group-header.collapsed .toggle-indicator { transform: rotate(-90deg); }
        #backlog-table tbody tr.task-row { border-left: 4px solid #90caf9; background-color: #fff; transition: background-color 0.1s ease, border-left-color 0.2s ease; /* Added border transition */ }
        #backlog-table tbody tr.task-row.hidden { display: none; }
        #backlog-table tbody tr.task-row:nth-child(even) { background-color: #f8fafd; }
        #backlog-table tbody tr.task-row:hover { background-color: #f0f4f8; }
        #backlog-table tbody tr.task-row.priority-Alta { border-left-color: #e57373; }
        #backlog-table tbody tr.task-row.priority-Bassa { border-left-color: #a5d6a7; }

        #backlog-table tbody td { border: 1px solid #e8eef3; padding: 5px 8px; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; border-left: none; /* Left border is on TR */ position: relative; /* For absolute positioning if needed */ }
        #backlog-table tbody td:first-child { border-left: 1px solid #e8eef3; }

        #backlog-table td.col-name { width: 30%; white-space: normal; }
        #backlog-table td.col-category { width: 10%; white-space: nowrap; }
        #backlog-table td.col-priority { width: 8%; white-space: nowrap; }
        #backlog-table td.col-duration-est { width: 8%; white-space: nowrap; }
        #backlog-table td.col-duration-act { width: 12%; white-space: nowrap; }
        #backlog-table td.col-elapsed { width: 8%; white-space: nowrap; font-size: 0.85em; color: #666; }
        #backlog-table td.col-actions { width: 18%; text-align: right; white-space: nowrap; }

        /* NEW: Hide edit elements by default */
        #backlog-table .edit-priority-input,
        #backlog-table .edit-duration-input,
        #backlog-table .save-edit-btn,
        #backlog-table .cancel-edit-btn {
            display: none;
        }

        /* NEW: Show edit elements and hide display elements when .editing class is present on TR */
        #backlog-table tr.editing .display-value,
        #backlog-table tr.editing .edit-duration-btn, /* Hide duration edit button */
        #backlog-table tr.editing .pin-btn,
        #backlog-table tr.editing .complete-btn,
        #backlog-table tr.editing .delete-btn,
        #backlog-table tr.editing .edit-task-btn {
             display: none;
        }
        #backlog-table tr.editing .edit-priority-input,
        #backlog-table tr.editing .edit-duration-input,
        #backlog-table tr.editing .save-edit-btn,
        #backlog-table tr.editing .cancel-edit-btn {
            display: inline-block; /* Or block/flex as needed */
            vertical-align: middle; /* Align with buttons */
        }
        #backlog-table tr.editing .edit-priority-input { width: calc(100% - 10px); /* Adjust width as needed */ }
        #backlog-table tr.editing .edit-duration-input { width: calc(100% - 10px); }


        /* Action Buttons in Backlog Table */
        #backlog-table .item-actions button {
            padding: 4px 7px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; font-size: 0.9em; line-height: 1; transition: background-color 0.2s, border-color 0.2s; margin-left: 4px; vertical-align: middle;
        }
        #backlog-table .pin-btn { background-color: #ede7f6; color: #5e35b1; border-color: #d1c4e9; font-weight: bold; } #backlog-table .pin-btn:hover { background-color: #d1c4e9; } #backlog-table .pin-btn:disabled { background-color: #f5f5f5; color: #bdbdbd; border-color: #e0e0e0; cursor: not-allowed; }
        #backlog-table .edit-duration-btn { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; } #backlog-table .edit-duration-btn:hover { background-color: #bdbdbd; }
        #backlog-table .complete-btn { background-color: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; } #backlog-table .complete-btn:hover { background-color: #c8e6c9; }
        #backlog-table .delete-btn { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; } #backlog-table .delete-btn:hover { background-color: #ffcdd2; }
        /* NEW: Edit/Save/Cancel Buttons */
        #backlog-table .edit-task-btn { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; } #backlog-table .edit-task-btn:hover { background-color: #bbdefb; }
        #backlog-table .save-edit-btn { background-color: #c8e6c9; color: #388e3c; border: 1px solid #a5d6a7; } #backlog-table .save-edit-btn:hover { background-color: #a5d6a7; }
        #backlog-table .cancel-edit-btn { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; } #backlog-table .cancel-edit-btn:hover { background-color: #e0e0e0; }


        /* Inline Actual Duration Edit */
        .actual-duration-inline-area { display: flex; align-items: center; gap: 4px; }
        .actual-duration-inline-area input { flex-grow: 1; padding: 3px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; min-width: 60px; }
        .actual-duration-inline-area button { background-color: #c8e6c9; color: #388e3c; border: 1px solid #a5d6a7; padding: 3px 6px; font-size: 0.9em; line-height: 1; }
         .actual-duration-inline-area button:hover { background-color: #a5d6a7; }
         .actual-duration-display { display: flex; align-items: center; gap: 5px; cursor: default; }
         .actual-duration-display .duration-text { flex-grow: 1; font-size: 0.9em; color: #33691e; }

        .backlog-empty-message td { text-align: center; font-style: italic; color: #888; padding: 15px; background-color: #fdfdfe; border-left: none !important; }

        /* --- Queue Table Styling (Unchanged) --- */
        .queue-section { border-top: 2px dashed #b0bec5; margin-top: 20px; }
        #queue-table { width: 100%; border-collapse: collapse; font-size: 0.9em; table-layout: fixed; }
        #queue-table thead th { background-color: #e9edf1; border: 1px solid #dce4ec; padding: 6px 8px; text-align: left; font-weight: 600; color: #4a6a8a; font-size: 0.85em; white-space: nowrap; }
        #queue-table tbody tr.queue-item { border-left-width: 4px; border-left-style: solid; border-left-color: #90caf9; background-color: #fff; transition: background-color 0.1s ease; }
        #queue-table tbody tr.queue-item:nth-child(even) { background-color: #f8fafd; }
        #queue-table tbody tr.queue-item:hover { background-color: #f0f4f8; }
        #queue-table tbody tr.queue-item.priority-Alta { border-left-color: #e57373; }
        #queue-table tbody tr.queue-item.priority-Normale { border-left-color: #90caf9; }
        #queue-table tbody tr.queue-item.priority-Bassa { border-left-color: #a5d6a7; }
        #queue-table tbody td { padding: 5px 8px; vertical-align: middle; border: 1px solid #e8eef3; border-left: none; overflow: hidden; text-overflow: ellipsis; }
        #queue-table tbody td:first-child { border-left: 1px solid #e8eef3; }
        #queue-table td.col-order { width: 15%; text-align: center; white-space: nowrap; }
        #queue-table td.col-name { width: 45%; }
        #queue-table td.col-details { width: 20%; font-size: 0.85em; color: #757575; white-space: nowrap; }
        #queue-table td.col-actions { width: 20%; text-align: right; white-space: nowrap; }
        #queue-table .item-actions-queue button, #queue-table .col-order button { padding: 4px 6px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; line-height: 1; transition: background-color 0.2s, border-color 0.2s; background-color: #f5f5f5; color: #616161; min-width: 26px; text-align: center; margin: 0 2px; vertical-align: middle; }
        #queue-table .item-actions-queue button:hover, #queue-table .col-order button:hover { background-color: #eeeeee; border-color: #bdbdbd; }
        #queue-table .item-actions-queue button:disabled, #queue-table .col-order button:disabled { background-color: #fafafa; color: #bdbdbd; cursor: not-allowed; border-color: #e0e0e0; }
        #queue-table .unpin-btn { border-color: #ffcdd2; color: #c62828; background-color: #ffebee; }
        #queue-table .unpin-btn:hover { background-color: #ffcdd2; }
        .queue-empty-message td { padding: 15px; text-align: center; font-style: italic; color: #888; background-color: #fdfdfe; border-left: none !important; }
        /* --- End Queue Styles --- */

        /* Completed/Template Table Styling (Unchanged) */
        #completed-tasks-container { margin-top: 10px; border-top: 1px solid #e8eef3; padding-top: 10px; }
        .task-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; color: #333; }
        .task-table thead th { background-color: #e9edf1; border: 1px solid #dce4ec; padding: 6px 8px; text-align: left; font-weight: 600; color: #4a6a8a; }
        .task-table tbody td { border: 1px solid #e8eef3; padding: 4px 8px; vertical-align: middle; }
        .task-table tbody tr:nth-child(even) { background-color: #f8fafd; }
        .task-table .action-cell { text-align: center; width: 40px; white-space: nowrap; }
        .task-table .delete-btn, .task-table .add-from-template-button { padding: 2px 5px; font-size: 0.9em; margin: 0 2px; }
        .task-table .placeholder-row td { text-align: center; font-style: italic; color: #888; padding: 10px; }
    </style>
</head>
<body>
<div class="container">
    <main class="app">
        {/* Aggiunta Nuova Attivit√† */}
        <section class="add-task-section card"><h2>Nuova Attivit√† Manuale</h2><div><label for="new-task-input">Nome attivit√†:</label><input type="text" id="new-task-input" placeholder="Es: Comprare il latte"></div><div class="form-row"><div><label for="new-task-category">Categoria:</label><select id="new-task-category"><option value="Generale">Generale</option><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option><option value="Lavoro">Lavoro</option><option value="Altro">Altro</option><option value="Svago">Svago</option><option value="Viaggi">Viaggi</option><option value="Casa">Casa</option><option value="Personale">Personale</option></select></div><div><label for="new-task-priority">Priorit√†:</label><select id="new-task-priority"><option value="Normale">Normale</option><option value="Bassa">Bassa</option><option value="Alta">Alta</option></select></div></div><div><label for="new-task-duration">Durata Stimata:</label><input type="text" id="new-task-duration" placeholder="Es: 1h 30m, 45m, 2h"></div><button id="add-task-button">Aggiungi al Backlog</button></section>

        {/* Template (DB Attivit√†) */}
        <section class="templates-section card" id="templates-section">
            <h2><span>Aggiungi da Template (DB Attivit√†)</span><button id="toggle-db-button" title="Nascondi DB Attivit√†">Nascondi DB</button></h2>
            <div class="table-wrapper">
                <table class="task-table" id="template-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Priorit√†</th>
                            <th>Stimata</th>
                            <th>Aggiungi</th>
                        </tr>
                    </thead>
                    <tbody id="template-list-body">
                        <tr class="placeholder-row"><td colspan="5">Caricamento template...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        {/* --- Backlog (Table Layout) --- */}
        <section class="backlog-section card">
            <h2>Backlog Attivit√† (Gruppi: Categoria / Ord: Priorit√†, Data ‚Üì)</h2>
            <div class="table-wrapper">
                <table id="backlog-table">
                    <thead>
                        <tr>
                            <th class="col-name">Nome</th>
                            <th class="col-category">Categoria</th>
                            <th class="col-priority">Priorit√†</th>
                            <th class="col-duration-est">Stimata</th>
                            <th class="col-duration-act">Effettiva</th>
                            <th class="col-elapsed">Trascorso</th>
                            <th class="col-actions">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="backlog-table-body">
                        <tr class="backlog-empty-message"><td colspan="7">Nessuna attivit√† nel backlog.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        {/* --- End Backlog --- */}


        {/* --- Coda (Table Layout with Priority Colors) --- */}
        <section class="queue-section card">
            <h2>Coda Attivit√† Attuali</h2>
            <div class="table-wrapper">
                <table id="queue-table">
                     <thead>
                        <tr>
                            <th class="col-order">Ordine</th>
                            <th class="col-name">Nome</th>
                            <th class="col-details">Dettagli (Cat/Pri)</th>
                            <th class="col-actions">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="queue-table-body">
                        <tr class="queue-empty-message"><td colspan="4">La coda √® vuota. Pinna attivit√† dal backlog.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        {/* --- End Coda --- */}


        {/* Concluse */}
        <section class="completed-section card">
             <button id="toggle-completed-button">Mostra Concluse (0)</button>
             <div id="completed-tasks-container" style="display: none;">
                <h2>Attivit√† Concluse</h2>
                <div class="table-wrapper">
                    <table class="task-table" id="completed-tasks-table">
                        <thead><tr><th>Nome</th><th>Cat.</th><th>Pri.</th><th>Stimata</th><th>Effettiva</th><th>Tempo Trascorso</th><th>Aggiunta</th><th>Completata</th><th>Azioni</th></tr></thead>
                        <tbody id="completed-list-body"><tr class="placeholder-row"><td colspan="9">Nessuna attivit√† completata.</td></tr></tbody>
                    </table>
                </div>
             </div>
        </section>

        {/* Export / Copy */}
        <section class="export-section card"><h2>Esporta / Copia Dati</h2><button id="export-summary-button" title="Scarica riepilogo .txt">Esporta Riepilogo (.txt)</button><button id="export-csv-button" title="Scarica .csv">Esporta CSV (.csv)</button><button id="copy-summary-button" class="copy-btn" title="Copia riepilogo">Copia Riepilogo</button><button id="copy-csv-button" class="copy-btn" title="Copia CSV">Copia CSV</button></section>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Riferimenti DOM (unchanged) ---
        const newTaskInput = document.getElementById('new-task-input');
        const newTaskCategory = document.getElementById('new-task-category');
        const newTaskPriority = document.getElementById('new-task-priority');
        const newTaskDuration = document.getElementById('new-task-duration');
        const addTaskButton = document.getElementById('add-task-button');
        const backlogTableBody = document.getElementById('backlog-table-body');
        const queueTableBody = document.getElementById('queue-table-body');
        const completedListBody = document.getElementById('completed-list-body');
        const toggleCompletedButton = document.getElementById('toggle-completed-button');
        const completedTasksContainer = document.getElementById('completed-tasks-container');
        const templateTable = document.getElementById('template-table');
        const templateListBody = document.getElementById('template-list-body');
        const toggleDbButton = document.getElementById('toggle-db-button');
        const exportSummaryButton = document.getElementById('export-summary-button');
        const exportCsvButton = document.getElementById('export-csv-button');
        const copySummaryButton = document.getElementById('copy-summary-button');
        const copyCsvButton = document.getElementById('copy-csv-button');

        // --- Stato Applicazione (unchanged versions) ---
        const STORAGE_KEY_BACKLOG = 'backlogTasks_v9.1'; // Keeping same key to load existing data
        const STORAGE_KEY_COMPLETED = 'completedTasks_v9.1';
        const STORAGE_KEY_QUEUE = 'queueTaskIds_v9.1';
        const STORAGE_KEY_COLLAPSED = 'collapsedGroups_v9.1';
        let backlogTasks = JSON.parse(localStorage.getItem(STORAGE_KEY_BACKLOG)) || [];
        let completedTasks = JSON.parse(localStorage.getItem(STORAGE_KEY_COMPLETED)) || [];
        let queueTaskIds = JSON.parse(localStorage.getItem(STORAGE_KEY_QUEUE)) || [];
        let collapsedGroups = JSON.parse(localStorage.getItem(STORAGE_KEY_COLLAPSED)) || {};
        let isDbTableVisible = templateTable.style.display !== 'none';
        let timerInterval = null;

        // --- TEMPLATES & Config (unchanged) ---
        const activityTemplates = [ { id: 'tpl-001', name: 'Pulizia Cucina', category: 'Casa', priority: 'Normale', estimatedDuration: '1h' }, { id: 'tpl-002', name: 'Fare la Spesa', category: 'Casa', priority: 'Normale', estimatedDuration: '1h 30m' }, { id: 'tpl-003', name: 'Report Settimanale', category: 'Lavoro', priority: 'Alta', estimatedDuration: '3h' }, { id: 'tpl-004', name: 'Chiamare Cliente X', category: 'Lavoro', priority: 'Alta', estimatedDuration: '15m' }, { id: 'tpl-005', name: 'Palestra', category: 'Personale', priority: 'Bassa', estimatedDuration: '1h' }, { id: 'tpl-006', name: 'Leggere Libro', category: 'Svago', priority: 'Bassa', estimatedDuration: '30m' }, { id: 'tpl-007', name: 'Pagare Bollette', category: 'Altro', priority: 'Alta', estimatedDuration: '10m' }, { id: 'tpl-008', name: 'Pianificare Viaggio', category: 'Viaggi', priority: 'Normale', estimatedDuration: '2h' }, { id: 'tpl-009', name: 'Fare Barba', category: 'Personale', priority: 'Bassa', estimatedDuration: '15m' } ];
        const priorityOrder = { 'Alta': 1, 'Normale': 2, 'Bassa': 3 };
        const priorityOptions = ['Normale', 'Bassa', 'Alta']; // For the edit dropdown
        const DEFAULT_CATEGORY = 'Generale';

        // --- Funzioni Utility Durata (unchanged) ---
        const parseDurationToMinutes = (durationString) => { if (!durationString || typeof durationString !== 'string') { return 0; } const cleanedString = durationString.trim().toLowerCase(); if (!cleanedString) { return 0; } let totalMinutes = 0; const durationRegex = /(?:(\d+)\s*h)?\s*(?:(\d+)\s*m)?/; const match = cleanedString.match(durationRegex); if (match) { const hours = parseInt(match[1], 10) || 0; const minutes = parseInt(match[2], 10) || 0; if (hours === 0 && minutes === 0) { const singleHourMatch = cleanedString.match(/^(\d+)\s*h$/); const singleMinuteMatch = cleanedString.match(/^(\d+)\s*m$/); if (singleHourMatch) { totalMinutes += parseInt(singleHourMatch[1], 10) * 60; } else if (singleMinuteMatch) { totalMinutes += parseInt(singleMinuteMatch[1], 10); } } else { totalMinutes = (hours * 60) + minutes; } } return totalMinutes > 0 ? totalMinutes : 0; };
        const isValidDurationFormat = (durationString) => { if (!durationString || typeof durationString !== 'string' || durationString.trim() === '') { return true; } const cleanedString = durationString.trim().toLowerCase(); const validationRegex = /^\s*(?:(\d+)\s*h)?\s*(?:(\d+)\s*m)?\s*$/; const match = cleanedString.match(validationRegex); return match !== null && (match[1] !== undefined || match[2] !== undefined); };
        const formatMinutesToDuration = (totalMinutes) => { if (totalMinutes === null || totalMinutes === undefined || totalMinutes <= 0) { return "N/A"; } const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; let formatted = ''; if (hours > 0) { formatted += `${hours}h`; } if (minutes > 0) { if (formatted.length > 0) formatted += ' '; formatted += `${minutes}m`; } return formatted || "0m"; };

        // --- Funzioni Core (save, dates, etc.) (unchanged) ---
        const saveTasks = () => {
            localStorage.setItem(STORAGE_KEY_BACKLOG, JSON.stringify(backlogTasks));
            localStorage.setItem(STORAGE_KEY_COMPLETED, JSON.stringify(completedTasks));
            localStorage.setItem(STORAGE_KEY_QUEUE, JSON.stringify(queueTaskIds));
            localStorage.setItem(STORAGE_KEY_COLLAPSED, JSON.stringify(collapsedGroups));
        };
        const formatDate = (ds, useISO = false) => { if (!ds) return ''; try { const d = new Date(ds); if (useISO) return d.toISOString(); return d.toLocaleString('it-IT', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) } catch (e) { return 'Data invalida' } };
        const calculateElapsedTime = (addedDateISOString) => { if (!addedDateISOString) return 'N/A'; try { const aD = new Date(addedDateISOString); const n = new Date(); const dM = n - aD; if (dM < 0) return '0:00'; const addD = aD.getDate(); const addM = aD.getMonth(); const addY = aD.getFullYear(); const curD = n.getDate(); const curM = n.getMonth(); const curY = n.getFullYear(); if (addY === curY && addM === curM && addD === curD) { const tM = Math.floor(dM / (1000 * 60)); const h = Math.floor(tM / 60); const m = tM % 60; const pH = String(h).padStart(2, '0'); const pM = String(m).padStart(2, '0'); return `${pH}:${pM}` } else { const days = Math.floor(dM / (1000 * 60 * 60 * 24)); return `${days} giorn${days === 1 ? 'o' : 'i'}` } } catch (e) { console.error("Error calculating elapsed time:", e); return 'Errore' } };

        // --- Helper to create table cells (unchanged) ---
        const createCell = (text, className = null) => {
            const td = document.createElement('td');
            td.textContent = text !== null && text !== undefined ? text : '';
            if (className) {
                td.classList.add(className);
            }
            if (className !== 'col-actions' && className !== 'col-order' && td.textContent) {
                 td.title = td.textContent;
            }
            return td;
        };

        // --- Element Creation Functions (createTaskElement modified) ---

        const createTaskElement = (task) => {
            const tr = document.createElement('tr');
            tr.classList.add('task-row');
            tr.setAttribute('data-id', task.id);
            tr.setAttribute('data-category', task.category || DEFAULT_CATEGORY);
            tr.classList.add(`priority-${task.priority || 'Normale'}`);

            tr.appendChild(createCell(task.name, 'col-name'));
            tr.appendChild(createCell(task.category || 'N/A', 'col-category'));

            // Priority Cell (with edit)
            const tdPriority = createCell('', 'col-priority');
            tdPriority.innerHTML = `
                <span class="display-value">${task.priority || 'N/A'}</span>
                <select class="edit-priority-input">
                    ${priorityOptions.map(opt =>
                        `<option value="${opt}" ${task.priority === opt ? 'selected' : ''}>${opt}</option>`
                    ).join('')}
                </select>
            `;
            tr.appendChild(tdPriority);

            // Estimated Duration Cell (with edit)
            const tdDurationEst = createCell('', 'col-duration-est');
            tdDurationEst.innerHTML = `
                <span class="display-value">${task.estimatedDuration || 'N/A'}</span>
                <input type="text" class="edit-duration-input" value="${task.estimatedDuration || ''}" placeholder="Es: 1h 30m">
            `;
            tr.appendChild(tdDurationEst);

            // Actual Duration Cell (unchanged structure)
            const tdActualDuration = createCell('', 'col-duration-act');
            tdActualDuration.innerHTML = `
                <div class="actual-duration-display" data-task-id="${task.id}">
                     <span class="duration-text">${task.actualDuration || 'N/A'}</span>
                     <button class="edit-duration-btn" title="Modifica Durata Effettiva">‚è±Ô∏è</button>
                </div>
                <div class="actual-duration-inline-area" style="display: none;" data-task-id="${task.id}">
                    <input type="text" class="actual-duration-input" placeholder="Es: 1h 15m" value="${task.actualDuration || ''}">
                    <button class="save-duration-btn" title="Salva Durata">üíæ</button>
                 </div>`;
            tr.appendChild(tdActualDuration);

            // Elapsed Time Cell (unchanged)
            const elapsedTd = createCell(calculateElapsedTime(task.addedDate), 'col-elapsed');
            elapsedTd.setAttribute('data-added-date', task.addedDate);
            elapsedTd.title = `Aggiunto: ${formatDate(task.addedDate)}`;
            tr.appendChild(elapsedTd);

            // Actions Cell (with added edit/save/cancel buttons)
            const tdActions = createCell('', 'col-actions');
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('item-actions');
            const isPinned = queueTaskIds.includes(task.id);
            actionsDiv.innerHTML = `
                <button class="edit-task-btn" title="Modifica Priorit√†/Stimata">‚úèÔ∏è</button>
                <button class="pin-btn" title="${isPinned ? "Gi√† in coda" : "Aggiungi alla coda"}" ${isPinned ? 'disabled' : ''}>üìå</button>
                <button class="complete-btn" title="Marca come completata">‚úì</button>
                <button class="delete-btn" title="Elimina task">‚úó</button>
                <button class="save-edit-btn" title="Salva Modifiche">üíæ</button>
                <button class="cancel-edit-btn" title="Annulla Modifiche">‚Ü©Ô∏è</button>
            `;
            tdActions.appendChild(actionsDiv);
            tr.appendChild(tdActions);

             if (collapsedGroups[task.category || DEFAULT_CATEGORY]) {
                 tr.classList.add('hidden');
             }

            return tr;
        };

        // createQueueElement, createTemplateElement, createCompletedElement (unchanged)
        const createQueueElement = (task, index, totalItems) => { /* ... same as before ... */
            const tr = document.createElement('tr');
            tr.classList.add('queue-item');
            tr.setAttribute('data-id', task.id);
            tr.classList.add(`priority-${task.priority || 'Normale'}`); // Add priority class

            const tdOrder = createCell('', 'col-order');
            const orderDiv = document.createElement('div');
            orderDiv.innerHTML = `
                <button class="move-up-btn" title="Sposta Su" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button class="move-down-btn" title="Sposta Gi√π" ${index === totalItems - 1 ? 'disabled' : ''}>‚Üì</button>
            `;
            tdOrder.appendChild(orderDiv);
            tr.appendChild(tdOrder);

            tr.appendChild(createCell(task.name, 'col-name'));
            tr.appendChild(createCell(`${task.category || 'N/A'} / ${task.priority || 'N/A'}`, 'col-details'));

            const tdActions = createCell('', 'col-actions');
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('item-actions-queue');
            actionsDiv.innerHTML = `
                <button class="unpin-btn" title="Rimuovi dalla coda">‚úó</button>
            `;
            tdActions.appendChild(actionsDiv);
            tr.appendChild(tdActions);

            return tr;
        };
        const createTemplateElement = (template) => { /* ... same as before ... */
             const tr = document.createElement('tr'); tr.setAttribute('data-template-id', template.id);
             tr.appendChild(createCell(template.name));
             tr.appendChild(createCell(template.category));
             tr.appendChild(createCell(template.priority));
             tr.appendChild(createCell(template.estimatedDuration));
             const actionTd = createCell('', 'action-cell');
             const addBtn = document.createElement('button'); addBtn.textContent = '+'; addBtn.classList.add('add-from-template-button'); addBtn.title = `Aggiungi "${template.name}" al backlog`; addBtn.onclick = (e) => { e.stopPropagation(); addTask(template.name, template.category, template.estimatedDuration, template.priority, 'Template'); }; actionTd.appendChild(addBtn);
             tr.appendChild(actionTd); return tr;
         };
        const createCompletedElement = (task) => { /* ... same as before ... */
             const tr = document.createElement('tr'); tr.setAttribute('data-id', task.id);
             tr.appendChild(createCell(task.name));
             tr.appendChild(createCell(task.category));
             tr.appendChild(createCell(task.priority));
             tr.appendChild(createCell(task.estimatedDuration));
             tr.appendChild(createCell(task.actualDuration));
             tr.appendChild(createCell(task.elapsedDuration));
             tr.appendChild(createCell(formatDate(task.addedDate)));
             tr.appendChild(createCell(formatDate(task.completedDate)));
             const actionTd = createCell('', 'action-cell');
             const deleteBtn = document.createElement('button'); deleteBtn.textContent = '‚úó'; deleteBtn.classList.add('delete-btn'); deleteBtn.title = "Elimina task completata"; actionTd.appendChild(deleteBtn);
             tr.appendChild(actionTd); return tr;
        }

        // --- Render Function (unchanged logic, relies on updated createTaskElement) ---
        const renderLists = () => {
            // --- Cancel any ongoing edits before re-rendering ---
            const currentlyEditing = backlogTableBody.querySelector('tr.task-row.editing');
            if (currentlyEditing) {
                currentlyEditing.classList.remove('editing'); // Just remove class, re-render will fix UI
            }
            // --- End Cancel Edit ---

            backlogTableBody.innerHTML = '';
            queueTableBody.innerHTML = '';
            completedListBody.innerHTML = '';
            templateListBody.innerHTML = '';
            let completedEmpty = true, templateEmpty = true, backlogEmpty = true;

            // 1. Prepare Backlog Data (Recalculates totals based on current backlogTasks)
            const sortedBacklog = [...backlogTasks].sort((a, b) => { const pC = (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99); if (pC !== 0) return pC; return new Date(b.addedDate) - new Date(a.addedDate); });
            const groupedTasks = {};
            sortedBacklog.forEach(task => {
                const category = task.category || DEFAULT_CATEGORY;
                if (!groupedTasks[category]) { groupedTasks[category] = { tasks: [], totalMinutes: 0 }; }
                groupedTasks[category].tasks.push(task);
                // *** This calculation uses the potentially EDITED estimatedDuration ***
                const minutes = parseDurationToMinutes(task.estimatedDuration);
                if (minutes > 0) { groupedTasks[category].totalMinutes += minutes; }
            });

            // 2. Render Backlog Table (Uses the correct totals and calls updated createTaskElement)
            const groupKeys = Object.keys(groupedTasks).sort();
            if (groupKeys.length > 0) {
                backlogEmpty = false;
                groupKeys.forEach(category => {
                    const group = groupedTasks[category];
                    const taskCount = group.tasks.length;
                    const isCollapsed = !!collapsedGroups[category];

                    const groupHeaderRow = document.createElement('tr');
                    groupHeaderRow.classList.add('backlog-group-header');
                    if (isCollapsed) groupHeaderRow.classList.add('collapsed');
                    groupHeaderRow.setAttribute('data-category', category);

                    const headerCell = document.createElement('td');
                    headerCell.setAttribute('colspan', '7');
                    // *** This displays the potentially UPDATED total duration ***
                    headerCell.innerHTML = `
                        <span class="toggle-indicator">${isCollapsed ? '‚ñ∫' : '‚ñº'}</span>
                        <span>${category}</span>
                        <span style="float: right; font-weight: normal; font-size: 0.9em; color: #555;" title="Task: ${taskCount}, Totale Stimato: ${formatMinutesToDuration(group.totalMinutes)}">
                            ${taskCount} task / Tot: ${formatMinutesToDuration(group.totalMinutes)}
                        </span>`;
                    groupHeaderRow.appendChild(headerCell);
                    backlogTableBody.appendChild(groupHeaderRow);

                    group.tasks.forEach(task => {
                        // *** Calls the MODIFIED createTaskElement which includes edit fields ***
                        // *** and applies the correct priority class based on current task data ***
                        const taskRow = createTaskElement(task);
                        backlogTableBody.appendChild(taskRow);
                    });
                });
            }
            if (backlogEmpty) {
                backlogTableBody.innerHTML = '<tr class="backlog-empty-message"><td colspan="7">Nessuna attivit√† nel backlog.</td></tr>';
            }

            // 3. Render Queue Table (Unchanged)
            if (queueTaskIds.length > 0) {
                queueTaskIds.forEach((taskId, index) => {
                    const task = backlogTasks.find(t => t.id === taskId);
                    if (task) {
                        // *** Queue items also reflect updated priority via CSS class ***
                        queueTableBody.appendChild(createQueueElement(task, index, queueTaskIds.length));
                    } else {
                         console.warn(`Task con ID ${taskId} nella coda non trovato nel backlog.`);
                         // Optionally remove invalid ID from queue
                         // queueTaskIds.splice(index, 1); // Be careful with mutation during iteration
                    }
                });
            } else {
                queueTableBody.innerHTML = '<tr class="queue-empty-message"><td colspan="4">La coda √® vuota. Pinna attivit√† dal backlog.</td></tr>';
            }

            // 4. Render Completed Table (Unchanged)
             [...completedTasks].sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate)).forEach(t => { completedListBody.appendChild(createCompletedElement(t)); completedEmpty = false; });

            // 5. Render Template Table (Unchanged)
            activityTemplates.forEach(t => { templateListBody.appendChild(createTemplateElement(t)); templateEmpty = false; });

            // 6. Placeholders e Update Bottoni (Unchanged)
            if (completedEmpty) completedListBody.innerHTML = '<tr class="placeholder-row"><td colspan="9">Nessuna attivit√† completata.</td></tr>';
            if (templateEmpty) templateListBody.innerHTML = '<tr class="placeholder-row"><td colspan="5">Nessun template disponibile.</td></tr>';
            const completedCount = completedTasks.length;
            toggleCompletedButton.textContent = completedTasksContainer.style.display === 'none' ? `Mostra Concluse (${completedCount})` : `Nascondi Concluse (${completedCount})`;

            startTimerUpdates();
        };

        // --- Timer Update Functions (unchanged) ---
        const updateTimers = () => { /* ... */ };
        const startTimerUpdates = () => { /* ... */ };

        // --- Core Task Functions (addTask, completeTask, saveActualDuration, deleteTask - mostly unchanged) ---
        const addTask = (n,c,d,p,s='Manuale') => { const tN=n.trim();if(!tN){alert("Nome attivit√† vuoto!");newTaskInput.focus();return;} const dS=d.trim();if(dS&&!isValidDurationFormat(dS)){alert(`Formato durata stimata non valido: "${dS}".\nUsare formati come "1h 30m", "45m", "2h".`);newTaskDuration.focus();return;} const nT={id:`task-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:tN,category:c||DEFAULT_CATEGORY,priority:p,estimatedDuration:dS||null,actualDuration:null,addedDate:new Date().toISOString(),elapsedDuration:null,isComplete:false,completedDate:null,source:s};backlogTasks.push(nT);saveTasks();renderLists();if(s==='Manuale'){newTaskInput.value='';newTaskCategory.value='Generale';newTaskPriority.value='Normale';newTaskDuration.value='';newTaskInput.focus();} };
        const completeTask = (id) => { /* ... same as before ... */ };
        const saveActualDuration = (id, durationValue) => { /* ... same as before ... */ };
        const deleteTask = (id, isFromBacklog) => { /* ... same as before ... */ };


        // --- NEW: Functions for Backlog Task Editing ---
        const startEditingTask = (taskRow) => {
            // Cancel any other edits first
             const otherEditing = backlogTableBody.querySelector('tr.task-row.editing');
             if (otherEditing && otherEditing !== taskRow) {
                 cancelEditingTask(otherEditing);
             }
             taskRow.classList.add('editing');
             // Focus the first editable field (e.g., priority)
             const prioritySelect = taskRow.querySelector('.edit-priority-input');
             if (prioritySelect) prioritySelect.focus();
        };

        const saveEditedTask = (taskRow) => {
            const taskId = taskRow.getAttribute('data-id');
            const taskIndex = backlogTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) {
                console.error("Task not found for saving edit:", taskId);
                cancelEditingTask(taskRow); // Revert UI if task not found
                return;
            }

            const prioritySelect = taskRow.querySelector('.edit-priority-input');
            const durationInput = taskRow.querySelector('.edit-duration-input');

            const newPriority = prioritySelect ? prioritySelect.value : backlogTasks[taskIndex].priority;
            const newDurationStr = durationInput ? durationInput.value.trim() : backlogTasks[taskIndex].estimatedDuration;

            // Validate Duration
            if (newDurationStr && !isValidDurationFormat(newDurationStr)) {
                alert(`Formato durata stimata non valido: "${newDurationStr}".\nUsare formati come "1h 30m", "45m", "2h".`);
                durationInput.focus();
                return; // Don't save, keep editing
            }

            // Update task object
            backlogTasks[taskIndex].priority = newPriority;
            backlogTasks[taskIndex].estimatedDuration = newDurationStr || null; // Store empty as null

            // Save and re-render
            saveTasks();
            renderLists(); // This will remove the 'editing' class and refresh everything
        };

        const cancelEditingTask = (taskRow) => {
             taskRow.classList.remove('editing');
             // Optional: Reset input values to original if needed, but re-render handles this
        };


        // --- Toggle Functions (unchanged) ---
        const toggleCompleted = () => { /* ... */ };
        const toggleDbSection = () => { /* ... */ };
        const toggleBacklogGroup = (category, headerRow) => { /* ... */ };

        // --- Queue Functions (unchanged) ---
        const pinTask = (taskId) => { /* ... */ };
        const unpinTask = (taskId, shouldRender = true) => { /* ... */ };
        const moveTaskInQueue = (taskId, direction) => { /* ... */ };

        // --- Export/Copy Functions (unchanged) ---
        const getAllTaskData=()=>{ /* ... */ };
        const downloadFile=(c,f,mT)=>{ /* ... */ };
        const escapeCsvField=(fV)=>{ /* ... */ };
        const copyToClipboard=async(text)=>{ /* ... */ };
        const generateSummaryText = () => { /* ... */ }; // Will reflect edited data
        const generateCsvContent=(tasks)=>{ /* ... */ }; // Will reflect edited data
        const exportSummary=()=>{ /* ... */ };
        const exportCsv=()=>{ /* ... */ };
        const copySummary=()=>{ /* ... */ };
        const copyCsv=()=>{ /* ... */ };


        // --- Event Listeners (Backlog listener updated) ---

        backlogTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const taskRow = target.closest('tr.task-row[data-id]');
            const groupHeaderRow = target.closest('tr.backlog-group-header[data-category]');

            if (groupHeaderRow) {
                 // Prevent group toggle if clicking within an editing row inside it (optional)
                 if (!target.closest('tr.editing')) {
                    const category = groupHeaderRow.getAttribute('data-category');
                    toggleBacklogGroup(category, groupHeaderRow);
                 }
            } else if (taskRow) {
                const taskId = taskRow.getAttribute('data-id');
                const isEditing = taskRow.classList.contains('editing');

                // --- Handle clicks INSIDE an editing row ---
                if (isEditing) {
                    if (target.classList.contains('save-edit-btn') || target.closest('.save-edit-btn')) {
                        saveEditedTask(taskRow);
                    } else if (target.classList.contains('cancel-edit-btn') || target.closest('.cancel-edit-btn')) {
                        cancelEditingTask(taskRow);
                    }
                    // Ignore other clicks within the editing row for now
                }
                // --- Handle clicks in a NON-editing row ---
                else {
                    if (target.classList.contains('edit-task-btn') || target.closest('.edit-task-btn')) {
                        startEditingTask(taskRow);
                    } else if (target.classList.contains('pin-btn') || target.closest('.pin-btn')) {
                        pinTask(taskId);
                    } else if (target.classList.contains('complete-btn') || target.closest('.complete-btn')) {
                        completeTask(taskId);
                    } else if (target.classList.contains('delete-btn') || target.closest('.delete-btn')) {
                        deleteTask(taskId, true);
                    } else if (target.classList.contains('edit-duration-btn') || target.closest('.edit-duration-btn')) {
                        // Handle inline actual duration edit (existing logic)
                        const displayDiv = taskRow.querySelector('.actual-duration-display');
                        const editDiv = taskRow.querySelector('.actual-duration-inline-area');
                        if (displayDiv && editDiv) {
                            displayDiv.style.display = 'none';
                            editDiv.style.display = 'flex';
                            editDiv.querySelector('.actual-duration-input').focus();
                            editDiv.querySelector('.actual-duration-input').select();
                        }
                    } else if (target.classList.contains('save-duration-btn') || target.closest('.save-duration-btn')) {
                         // Handle inline actual duration save (existing logic)
                        const input = taskRow.querySelector('.actual-duration-input');
                        if (input) {
                            saveActualDuration(taskId, input.value);
                        }
                    }
                }
            }
        });

        // --- Other Event Listeners (unchanged) ---
        queueTableBody.addEventListener('click', (e) => { /* ... same as before ... */ });
        completedListBody.addEventListener('click', (e) => { /* ... same as before ... */ });
        addTaskButton.addEventListener('click', () => { addTask(newTaskInput.value, newTaskCategory.value, newTaskDuration.value, newTaskPriority.value, 'Manuale'); });
        newTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(newTaskInput.value, newTaskCategory.value, newTaskDuration.value, newTaskPriority.value, 'Manuale'); } });
        newTaskDuration.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(newTaskInput.value, newTaskCategory.value, newTaskDuration.value, newTaskPriority.value, 'Manuale'); } });
        toggleCompletedButton.addEventListener('click', toggleCompleted);
        toggleDbButton.addEventListener('click', toggleDbSection);
        exportSummaryButton.addEventListener('click', exportSummary);
        exportCsvButton.addEventListener('click', exportCsv);
        copySummaryButton.addEventListener('click', copySummary);
        copyCsvButton.addEventListener('click', copyCsv);

        // --- Inizializzazione (unchanged) ---
        collapsedGroups = JSON.parse(localStorage.getItem(STORAGE_KEY_COLLAPSED)) || {};
        renderLists();
        if (!isDbTableVisible && templateTable) { templateTable.style.display = 'none'; toggleDbButton.textContent = 'Mostra DB'; toggleDbButton.title = "Mostra DB Attivit√†"; }
        else if (toggleDbButton) { toggleDbButton.textContent = 'Nascondi DB'; toggleDbButton.title = "Nascondi DB Attivit√†"; }
    });
</script>
</body>
</html>
